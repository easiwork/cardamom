<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cardamom - Recipe Vault</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.4.0/dist/mermaid.min.js"></script>
    <script>
      // Check if Mermaid is loaded
      window.addEventListener("load", function () {
        if (typeof mermaid === "undefined") {
          console.error("Mermaid library failed to load");
        } else {
          console.log("Mermaid library loaded successfully");
        }
      });
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f5f5f7;
        color: #1d1d1f;
        height: 100vh;
        overflow: hidden;
        -webkit-app-region: no-drag;
      }

      /* Mac Native Window Styling */
      .mac-window {
        background: #f5f5f7;
        border-radius: 12px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .mac-titlebar {
        background: #e5e5e7;
        height: 28px;
        display: flex;
        align-items: center;
        padding: 0 12px;
        border-radius: 12px 12px 0 0;
        -webkit-app-region: drag;
      }

      .mac-controls {
        display: flex;
        gap: 8px;
      }

      .mac-control {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        -webkit-app-region: no-drag;
      }

      .mac-control.close {
        background: #ff5f57;
      }

      .mac-control.minimize {
        background: #ffbd2e;
      }

      .mac-control.maximize {
        background: #28ca42;
      }

      .app-container {
        display: flex;
        flex: 1;
        height: calc(100vh - 28px);
      }

      /* Left Sidebar - Recipe Cards */
      .sidebar {
        width: 320px;
        background: #ffffff;
        border-right: 1px solid #e5e5e7;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .sidebar-header {
        padding: 24px 20px 16px;
        border-bottom: 1px solid #e5e5e7;
        background: #ffffff;
      }

      .sidebar-header h1 {
        font-size: 1.4em;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 4px;
      }

      .sidebar-header p {
        font-size: 0.85em;
        color: #86868b;
        line-height: 1.4;
      }

      .new-recipe-btn {
        width: 100%;
        background: #007aff;
        border: none;
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        margin: 16px 20px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .new-recipe-btn:hover {
        background: #0056b3;
        transform: translateY(-1px);
      }

      .recipes-section {
        flex: 1;
        overflow-y: auto;
        padding: 0 20px 20px;
      }

      .recipes-section h3 {
        font-size: 0.8em;
        color: #86868b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
        font-weight: 600;
        padding: 0 4px;
      }

      .recipe-card {
        background: #ffffff;
        border: 1px solid #e5e5e7;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .recipe-card:hover {
        background: #f9f9f9;
        border-color: #007aff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .recipe-card.active {
        background: #e3f2fd;
        border-color: #007aff;
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
      }

      .recipe-card-image {
        width: 100%;
        height: 120px;
        background: #f5f5f7;
        border-radius: 8px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #86868b;
        font-size: 0.8em;
        overflow: hidden;
      }

      .recipe-card-title {
        font-size: 0.95em;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 8px;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .recipe-card-meta {
        font-size: 0.75em;
        color: #86868b;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .recipe-card-date {
        font-size: 0.7em;
      }

      .recipe-card-actions {
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .recipe-card:hover .recipe-card-actions {
        opacity: 1;
      }

      .recipe-card-btn {
        background: transparent;
        border: none;
        color: #86868b;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        font-size: 0.8em;
        transition: all 0.2s ease;
      }

      .recipe-card-btn:hover {
        background: #e5e5e7;
        color: #1d1d1f;
      }

      .recipe-card-btn.delete:hover {
        background: #ff3b30;
        color: white;
      }

      /* Main Content Area */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #f5f5f7;
      }

      /* Expanded Recipe View */
      .expanded-recipe-view {
        height: 400px;
        background: #ffffff;
        border-bottom: 1px solid #e5e5e7;
        display: none;
        flex-direction: row;
        overflow: hidden;
      }

      .expanded-recipe-view.active {
        display: flex;
      }

      .recipe-details-panel {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }

      .recipe-details-header {
        margin-bottom: 20px;
      }

      .recipe-details-title {
        font-size: 1.8em;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 8px;
      }

      .recipe-details-meta {
        display: flex;
        gap: 16px;
        font-size: 0.9em;
        color: #86868b;
        margin-bottom: 20px;
      }

      .recipe-ingredients {
        margin-bottom: 24px;
      }

      .recipe-ingredients h3 {
        font-size: 1.1em;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 12px;
      }

      .ingredient-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 8px;
      }

      .ingredient-item {
        background: #f9f9f9;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.9em;
        color: #1d1d1f;
        border-left: 3px solid #007aff;
      }

      .recipe-flowchart-panel {
        flex: 1;
        padding: 24px;
        background: #f9f9f9;
        border-left: 1px solid #e5e5e7;
        overflow-y: auto;
      }

      .recipe-flowchart-panel h3 {
        font-size: 1.1em;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 16px;
      }

      .flowchart-container {
        background: #ffffff;
        border: 1px solid #e5e5e7;
        border-radius: 12px;
        padding: 20px;
        overflow-x: auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .flowchart-container svg {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* Chat Area */
      .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #ffffff;
        margin: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .chat-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e5e7;
        background: #ffffff;
      }

      .chat-header h2 {
        font-size: 1.2em;
        font-weight: 600;
        color: #1d1d1f;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .message {
        display: flex;
        gap: 16px;
        max-width: 100%;
      }

      .message.user {
        flex-direction: row-reverse;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9em;
        font-weight: 600;
        flex-shrink: 0;
      }

      .message.user .message-avatar {
        background: #007aff;
        color: white;
      }

      .message.assistant .message-avatar {
        background: #34c759;
        color: white;
      }

      .message-content {
        flex: 1;
        max-width: calc(100% - 48px);
      }

      .message.user .message-content {
        text-align: right;
      }

      .message-text {
        background: #f2f2f7;
        padding: 16px 20px;
        border-radius: 18px;
        color: #1d1d1f;
        line-height: 1.5;
        word-wrap: break-word;
        border: 1px solid #e5e5e7;
      }

      .message.user .message-text {
        background: #007aff;
        border-color: #007aff;
        color: white;
      }

      .message-time {
        font-size: 0.75em;
        color: #86868b;
        margin-top: 8px;
        padding: 0 4px;
      }

      .message.user .message-time {
        text-align: right;
      }

      /* Chat Input */
      .chat-input-container {
        padding: 24px;
        border-top: 1px solid #e5e5e7;
        background: #ffffff;
      }

      .chat-input-wrapper {
        position: relative;
        max-width: 800px;
        margin: 0 auto;
      }

      .chat-input {
        width: 100%;
        background: #f2f2f7;
        border: 1px solid #e5e5e7;
        border-radius: 12px;
        padding: 16px 60px 16px 20px;
        color: #1d1d1f;
        font-size: 16px;
        line-height: 1.5;
        resize: none;
        min-height: 24px;
        max-height: 200px;
        font-family: inherit;
        transition: all 0.2s ease;
      }

      .chat-input:focus {
        outline: none;
        border-color: #007aff;
        box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
      }

      .chat-input::placeholder {
        color: #86868b;
      }

      .chat-send-btn {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: #007aff;
        border: none;
        border-radius: 8px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        transition: all 0.2s ease;
      }

      .chat-send-btn:hover:not(:disabled) {
        background: #0056b3;
      }

      .chat-send-btn:disabled {
        background: #e5e5e7;
        cursor: not-allowed;
        opacity: 0.5;
      }

      /* Welcome Message */
      .welcome-message {
        text-align: center;
        padding: 60px 24px;
        color: #86868b;
      }

      .welcome-message h3 {
        font-size: 1.5em;
        color: #1d1d1f;
        margin-bottom: 16px;
        font-weight: 600;
      }

      .welcome-message p {
        font-size: 1em;
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto 32px;
      }

      .welcome-examples {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        max-width: 800px;
        margin: 0 auto;
      }

      .example-card {
        background: #ffffff;
        border: 1px solid #e5e5e7;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .example-card:hover {
        background: #f9f9f9;
        border-color: #007aff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .example-card h4 {
        color: #1d1d1f;
        font-size: 0.9em;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .example-card p {
        color: #86868b;
        font-size: 0.85em;
        line-height: 1.4;
        margin: 0;
      }

      /* Flowchart Actions */
      .flowchart-actions {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        flex-wrap: wrap;
      }

      .flowchart-btn {
        background: #f2f2f7;
        border: 1px solid #e5e5e7;
        color: #1d1d1f;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .flowchart-btn:hover {
        background: #e5e5e7;
        border-color: #007aff;
      }

      .flowchart-btn.primary {
        background: #007aff;
        border-color: #007aff;
        color: white;
      }

      .flowchart-btn.primary:hover {
        background: #0056b3;
        border-color: #0056b3;
      }

      /* Loading States */
      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #86868b;
        font-style: italic;
        padding: 16px 20px;
        background: #f2f2f7;
        border-radius: 18px;
        border: 1px solid #e5e5e7;
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .typing-dot {
        width: 6px;
        height: 6px;
        background: #86868b;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
      }

      .typing-dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Toast notification */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 12px;
        padding: 16px 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 10000;
        transform: translateX(400px);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 400px;
        font-weight: 500;
        color: #1d1d1f;
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast.success {
        border-left: 4px solid #34c759;
        color: #1d1d1f;
      }

      .toast.error {
        border-left: 4px solid #ff3b30;
        color: #1d1d1f;
      }

      .toast.info {
        border-left: 4px solid #007aff;
        color: #1d1d1f;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .app-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          height: auto;
          max-height: 200px;
          border-right: none;
          border-bottom: 1px solid #4d4d4f;
        }

        .sidebar-header {
          padding: 16px;
        }

        .recipes-section {
          padding: 0 16px 16px;
        }

        .main-content {
          flex: 1;
          min-height: 0;
        }

        .chat-messages {
          padding: 16px;
        }

        .chat-input-container {
          padding: 16px;
        }

        .welcome-examples {
          grid-template-columns: 1fr;
        }

        .toast {
          right: 10px;
          left: 10px;
          max-width: none;
          transform: translateY(-100px);
        }

        .toast.show {
          transform: translateY(0);
        }
      }

      @media (max-width: 480px) {
        .sidebar-header h1 {
          font-size: 1.3em;
        }

        .chat-header {
          padding: 16px;
        }

        .chat-header h2 {
          font-size: 1.1em;
        }

        .message-text {
          padding: 12px 16px;
        }

        .flowchart-container {
          padding: 16px;
        }

        .flowchart-actions {
          flex-direction: column;
        }

        .flowchart-btn {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="mac-window">
      <!-- Mac Title Bar -->
      <div class="mac-titlebar">
        <div class="mac-controls">
          <div class="mac-control close"></div>
          <div class="mac-control minimize"></div>
          <div class="mac-control maximize"></div>
        </div>
      </div>

      <div class="app-container">
        <!-- Left Sidebar - Recipe Cards -->
        <div class="sidebar">
          <div class="sidebar-header">
            <h1>🌿 Cardamom</h1>
            <p>Recipe Vault - Your culinary collection</p>
          </div>

          <button class="new-recipe-btn" onclick="startNewChat()">
            <span>+</span> New Recipe
          </button>

          <div class="recipes-section">
            <h3>Recent Recipes</h3>
            <div id="recipeCardsList">
              <!-- Recipe cards will be populated here -->
            </div>
          </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
          <!-- Expanded Recipe View -->
          <div class="expanded-recipe-view" id="expandedRecipeView">
            <div class="recipe-details-panel">
              <div class="recipe-details-header">
                <h2 class="recipe-details-title" id="expandedRecipeTitle">
                  Select a Recipe
                </h2>
                <div class="recipe-details-meta" id="expandedRecipeMeta">
                  <!-- Recipe metadata will be populated here -->
                </div>
              </div>

              <div class="recipe-ingredients" id="expandedRecipeIngredients">
                <h3>Ingredients</h3>
                <div class="ingredient-list" id="ingredientList">
                  <!-- Ingredients will be populated here -->
                </div>
              </div>
            </div>

            <div class="recipe-flowchart-panel">
              <h3>Recipe Flowchart</h3>
              <div class="flowchart-container" id="expandedFlowchartContainer">
                <div id="expandedFlowchart">
                  <!-- Flowchart will be rendered here -->
                </div>
                <div class="flowchart-actions">
                  <button
                    class="flowchart-btn primary"
                    onclick="downloadExpandedFlowchart()"
                  >
                    💾 Download Flowchart
                  </button>
                  <button
                    class="flowchart-btn"
                    onclick="toggleExpandedRawCode()"
                  >
                    🔍 Show Raw Code
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Chat Area -->
          <div class="chat-area">
            <div class="chat-header">
              <h2 id="chatTitle">Cooking Assistant</h2>
            </div>

            <div class="chat-messages" id="chatMessages">
              <div class="welcome-message">
                <h3>🌿 Welcome to Cardamom</h3>
                <p>
                  Your personal recipe vault and cooking companion! Save
                  recipes, get cooking tips, ingredient substitutions, and
                  create beautiful flowcharts from your recipes. Let's explore
                  the culinary world together!
                </p>

                <div class="welcome-examples">
                  <div
                    class="example-card"
                    onclick="sendExampleMessage('https://www.allrecipes.com/recipe/21014/good-old-fashioned-pancakes/')"
                  >
                    <h4>🌐 Recipe URL</h4>
                    <p>Share a recipe URL to create a flowchart</p>
                  </div>

                  <div
                    class="example-card"
                    onclick="sendExampleMessage('Classic Chocolate Chip Cookies\n\nIngredients:\n- 2 1/4 cups all-purpose flour\n- 1 tsp baking soda\n- 1 tsp salt\n- 1 cup butter, softened\n- 3/4 cup granulated sugar\n- 3/4 cup brown sugar\n- 2 large eggs\n- 2 tsp vanilla extract\n- 2 cups chocolate chips\n\nInstructions:\n1. Preheat oven to 375°F\n2. Mix flour, baking soda, and salt\n3. Cream butter and sugars\n4. Beat in eggs and vanilla\n5. Gradually blend in flour mixture\n6. Stir in chocolate chips\n7. Drop rounded tablespoons onto ungreased cookie sheets\n8. Bake 9-11 minutes until golden brown')"
                  >
                    <h4>📝 Recipe Text</h4>
                    <p>Paste a recipe to create a flowchart</p>
                  </div>

                  <div
                    class="example-card"
                    onclick="sendExampleMessage('What are some good substitutes for eggs in baking?')"
                  >
                    <h4>💡 Cooking Tips</h4>
                    <p>Ask me about cooking techniques and substitutions</p>
                  </div>

                  <div class="example-card" onclick="loadExampleRecipe()">
                    <h4>🎯 Try Example</h4>
                    <p>Load the Mapo Tofu example recipe</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="chat-input-container">
              <div class="chat-input-wrapper">
                <textarea
                  id="chatInput"
                  class="chat-input"
                  placeholder="Ask about cooking, share a recipe, or paste a recipe URL..."
                  rows="1"
                ></textarea>
                <button
                  class="chat-send-btn"
                  id="sendBtn"
                  onclick="sendMessage()"
                >
                  <span>→</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Initialize Mermaid
      mermaid.initialize({
        startOnLoad: false,
        theme: "default",
        flowchart: {
          useMaxWidth: true,
          htmlLabels: true,
        },
      });

      // Global state
      let currentRecipeData = null;
      let deviceId = null;
      let isProcessing = false;
      let currentRecipeId = null;
      let conversationHistory = [];

      // Chat interface functions
      function addMessage(content, type = "user", timestamp = new Date()) {
        const messagesContainer = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.textContent = type === "user" ? "U" : "AI";

        const messageContent = document.createElement("div");
        messageContent.className = "message-content";

        const messageText = document.createElement("div");
        messageText.className = "message-text";
        messageText.innerHTML = content;

        const messageTime = document.createElement("div");
        messageTime.className = "message-time";
        messageTime.textContent = timestamp.toLocaleTimeString();

        messageContent.appendChild(messageText);
        messageContent.appendChild(messageTime);
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Store message in conversation history
        conversationHistory.push({
          role: type === "user" ? "user" : "assistant",
          content: content,
          timestamp: timestamp,
        });

        // Keep only the last 20 messages to prevent context from getting too long
        if (conversationHistory.length > 20) {
          conversationHistory = conversationHistory.slice(-20);
        }

        return messageDiv;
      }

      function addTypingIndicator() {
        const messagesContainer = document.getElementById("chatMessages");
        const typingDiv = document.createElement("div");
        typingDiv.className = "message assistant";
        typingDiv.id = "typingIndicator";

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.textContent = "AI";

        const messageContent = document.createElement("div");
        messageContent.className = "message-content";

        const typingIndicator = document.createElement("div");
        typingIndicator.className = "typing-indicator";
        typingIndicator.innerHTML = `
          <span>AI is thinking</span>
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        `;

        messageContent.appendChild(typingIndicator);
        typingDiv.appendChild(avatar);
        typingDiv.appendChild(messageContent);

        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function removeTypingIndicator() {
        const typingIndicator = document.getElementById("typingIndicator");
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      function clearWelcomeMessage() {
        const welcomeMessage = document.querySelector(".welcome-message");
        if (welcomeMessage) {
          welcomeMessage.remove();
        }
      }

      // Input detection
      function detectInputType(input) {
        const trimmedInput = input.trim();

        if (isValidUrl(trimmedInput)) {
          return "url";
        }

        // Check if it looks like a recipe (has ingredients and instructions)
        const recipeKeywords = [
          "ingredients",
          "instructions",
          "directions",
          "recipe",
          "cook",
          "bake",
          "fry",
          "boil",
          "tablespoon",
          "teaspoon",
          "cup",
          "pound",
          "ounce",
          "gram",
          "kilogram",
          "liter",
          "preheat",
          "mix",
          "combine",
          "add",
          "stir",
          "whisk",
          "beat",
          "fold",
          "knead",
          "season",
          "salt",
          "pepper",
          "sugar",
          "flour",
          "butter",
          "oil",
          "eggs",
          "milk",
        ];

        const lowerInput = trimmedInput.toLowerCase();
        const keywordCount = recipeKeywords.filter((keyword) =>
          lowerInput.includes(keyword)
        ).length;

        // Check for structured recipe format (has both ingredients and instructions)
        const hasIngredients =
          lowerInput.includes("ingredients") ||
          (lowerInput.includes("ingredient") && keywordCount >= 2);
        const hasInstructions =
          lowerInput.includes("instructions") ||
          lowerInput.includes("directions") ||
          (lowerInput.includes("step") && keywordCount >= 2);

        // If it has both ingredients and instructions, treat as recipe
        if (hasIngredients && hasInstructions && trimmedInput.length > 100) {
          return "recipe";
        }

        // If it has many recipe keywords and is long, likely a recipe
        if (keywordCount >= 4 && trimmedInput.length > 150) {
          return "recipe";
        }

        // If it's a short question or general chat, treat as chat
        if (trimmedInput.length < 100 && !hasIngredients && !hasInstructions) {
          return "chat";
        }

        // Default to chat for general cooking questions
        return "chat";
      }

      // URL validation helper
      function isValidUrl(string) {
        try {
          const url = new URL(string);
          return ["http:", "https:"].includes(url.protocol);
        } catch (_) {
          return false;
        }
      }

      // Main chat functions
      function sendMessage() {
        const chatInput = document.getElementById("chatInput");
        const message = chatInput.value.trim();

        if (!message || isProcessing) return;

        // Clear input and add user message
        chatInput.value = "";
        addMessage(message, "user");
        clearWelcomeMessage();

        // Process the message
        processUserMessage(message);
      }

      function sendExampleMessage(message) {
        const chatInput = document.getElementById("chatInput");
        chatInput.value = message;
        sendMessage();
      }

      async function processUserMessage(message) {
        isProcessing = true;
        updateSendButton();

        addTypingIndicator();

        try {
          const inputType = detectInputType(message);

          let response;
          if (inputType === "url") {
            response = await fetch(
              `/api/process-url/${encodeURIComponent(message)}`
            );
          } else if (inputType === "recipe") {
            response = await fetch("/api/process-recipe", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ recipeText: message }),
            });
          } else {
            // Handle general chat
            response = await fetch("/api/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                message: message,
                conversationHistory: conversationHistory.slice(0, -1), // Exclude the current message
              }),
            });
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to process message");
          }

          const result = await response.json();
          removeTypingIndicator();

          if (inputType === "recipe" || inputType === "url") {
            // Save the recipe automatically
            const recipeId = saveRecipeToStorage(result);
            currentRecipeData = result;
            currentRecipeId = recipeId;

            // Display the result
            displayRecipeResult(result);

            // Update recipe cards
            updateRecipeCards();
          } else {
            // Handle general chat response
            addMessage(
              result.response ||
                result.message ||
                "I'm here to help with your cooking questions!",
              "assistant"
            );
          }
        } catch (error) {
          removeTypingIndicator();
          addMessage(
            `Sorry, I encountered an error: ${error.message}`,
            "assistant"
          );
        } finally {
          isProcessing = false;
          updateSendButton();
        }
      }

      function displayRecipeResult(result) {
        const recipeName = result.recipeName || result.scrapedTitle || "Recipe";

        // Show expanded recipe view
        showExpandedRecipeView(result);

        // Add ingredients and steps to chat
        addRecipeToChat(result);

        // Add success message
        addMessage(
          `<h4>🍳 ${recipeName}</h4>
          <p>I've created a beautiful flowchart for your recipe! The recipe has been automatically saved to your collection and is now displayed in the expanded view above.</p>`,
          "assistant"
        );
      }

      function downloadExpandedFlowchart() {
        if (!currentRecipeData || !currentRecipeData.mermaidDiagram) {
          showToast("No flowchart available to download.", "error");
          return;
        }

        const recipeName =
          currentRecipeData.recipeName ||
          currentRecipeData.scrapedTitle ||
          "recipe";
        downloadMermaidCode(currentRecipeData.mermaidDiagram, recipeName);
      }

      function toggleExpandedRawCode() {
        if (!currentRecipeData || !currentRecipeData.mermaidDiagram) {
          showToast("No flowchart code available.", "error");
          return;
        }

        const codeHtml = `
          <div style="background: #f2f2f7; color: #1d1d1f; padding: 16px; border-radius: 8px; margin-top: 12px; font-family: monospace; font-size: 12px; overflow-x: auto; border: 1px solid #e5e5e7;">
            <pre>${escapeHtml(currentRecipeData.mermaidDiagram)}</pre>
          </div>
        `;

        addMessage(`<h4>🔧 Raw Mermaid Code</h4>${codeHtml}`, "assistant");
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function updateSendButton() {
        const sendBtn = document.getElementById("sendBtn");

        if (isProcessing) {
          sendBtn.disabled = true;
          sendBtn.innerHTML = "<span>⏳</span>";
        } else {
          sendBtn.disabled = false;
          sendBtn.innerHTML = "<span>→</span>";
        }
      }

      function startNewChat() {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = `
          <div class="welcome-message">
            <h3>🌿 Welcome to Cardamom</h3>
            <p>Your personal recipe vault and cooking companion! Save recipes, get cooking tips, 
            ingredient substitutions, and create beautiful flowcharts from your recipes. 
            Let's explore the culinary world together!</p>
            
            <div class="welcome-examples">
              <div class="example-card" onclick="sendExampleMessage('https://www.allrecipes.com/recipe/21014/good-old-fashioned-pancakes/')">
                <h4>🌐 Recipe URL</h4>
                <p>Share a recipe URL to create a flowchart</p>
              </div>
              
              <div class="example-card" onclick="sendExampleMessage('Classic Chocolate Chip Cookies\\n\\nIngredients:\\n- 2 1/4 cups all-purpose flour\\n- 1 tsp baking soda\\n- 1 tsp salt\\n- 1 cup butter, softened\\n- 3/4 cup granulated sugar\\n- 3/4 cup brown sugar\\n- 2 large eggs\\n- 2 tsp vanilla extract\\n- 2 cups chocolate chips\\n\\nInstructions:\\n1. Preheat oven to 375°F\\n2. Mix flour, baking soda, and salt\\n3. Cream butter and sugars\\n4. Beat in eggs and vanilla\\n5. Gradually blend in flour mixture\\n6. Stir in chocolate chips\\n7. Drop rounded tablespoons onto ungreased cookie sheets\\n8. Bake 9-11 minutes until golden brown')">
                <h4>📝 Recipe Text</h4>
                <p>Paste a recipe to create a flowchart</p>
              </div>
              
              <div class="example-card" onclick="sendExampleMessage('What are some good substitutes for eggs in baking?')">
                <h4>💡 Cooking Tips</h4>
                <p>Ask me about cooking techniques and substitutions</p>
              </div>
              
              <div class="example-card" onclick="loadExampleRecipe()">
                <h4>🎯 Try Example</h4>
                <p>Load the Mapo Tofu example recipe</p>
              </div>
            </div>
          </div>
        `;

        // Hide expanded recipe view
        const expandedView = document.getElementById("expandedRecipeView");
        expandedView.classList.remove("active");

        currentRecipeData = null;
        currentRecipeId = null;
        conversationHistory = []; // Clear conversation history

        // Update recipe cards to remove active state
        updateRecipeCards();
      }

      // Storage and recipe management
      function initializeStorage() {
        const cookies = document.cookie.split(";");
        let foundDeviceId = null;

        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split("=");
          if (name === "deviceId") {
            foundDeviceId = value;
            break;
          }
        }

        if (!foundDeviceId) {
          foundDeviceId =
            "device_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 9);
          document.cookie = `deviceId=${foundDeviceId}; max-age=${
            365 * 24 * 60 * 60
          }; path=/`;
        }

        deviceId = foundDeviceId;
        console.log("🆔 Device ID initialized:", deviceId);

        // Load recipe cards on initialization
        updateRecipeCards();
      }

      function saveRecipeToStorage(recipeData) {
        if (!deviceId) return null;

        const recipeId =
          "recipe_" +
          Date.now() +
          "_" +
          Math.random().toString(36).substr(2, 9);
        const recipeName =
          recipeData.recipeName || recipeData.scrapedTitle || "Untitled Recipe";

        const recipeToSave = {
          id: recipeId,
          name: recipeName,
          data: recipeData,
          timestamp: new Date().toISOString(),
          deviceId: deviceId,
        };

        const savedRecipes = getSavedRecipes();
        savedRecipes.unshift(recipeToSave); // Add to beginning

        // Keep only the last 50 recipes
        if (savedRecipes.length > 50) {
          savedRecipes.splice(50);
        }

        localStorage.setItem(
          `savedRecipes_${deviceId}`,
          JSON.stringify(savedRecipes)
        );

        showToast(`Recipe "${recipeName}" saved successfully!`, "success");

        return recipeId;
      }

      function getSavedRecipes() {
        if (!deviceId) return [];

        const saved = localStorage.getItem(`savedRecipes_${deviceId}`);
        return saved ? JSON.parse(saved) : [];
      }

      function updateRecipeCards() {
        const recipeCardsList = document.getElementById("recipeCardsList");
        const savedRecipes = getSavedRecipes();

        if (savedRecipes.length === 0) {
          recipeCardsList.innerHTML =
            '<p style="color: #86868b; font-size: 0.9em; text-align: center; padding: 20px;">No recipes yet. Start by sharing a recipe!</p>';
          return;
        }

        recipeCardsList.innerHTML = savedRecipes
          .map(
            (recipe) => `
          <div class="recipe-card ${
            recipe.id === currentRecipeId ? "active" : ""
          }" onclick="loadRecipe('${recipe.id}')">
            <div class="recipe-card-image">
              ${
                recipe.data.imageUrl
                  ? `<img src="${recipe.data.imageUrl}" alt="${recipe.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`
                  : "🍳"
              }
            </div>
            <div class="recipe-card-title">${recipe.name}</div>
            <div class="recipe-card-meta">
              <span class="recipe-card-date">${new Date(
                recipe.timestamp
              ).toLocaleDateString()}</span>
              <div class="recipe-card-actions">
                <button class="recipe-card-btn" onclick="event.stopPropagation(); downloadRecipe('${
                  recipe.id
                }')" title="Download">
                  💾
                </button>
                <button class="recipe-card-btn delete" onclick="event.stopPropagation(); deleteRecipe('${
                  recipe.id
                }')" title="Delete">
                  🗑️
                </button>
                </div>
                </div>
              </div>
            `
          )
          .join("");
      }

      function loadRecipe(recipeId) {
        const savedRecipes = getSavedRecipes();
        const recipe = savedRecipes.find((r) => r.id === recipeId);

        if (!recipe) {
          showToast("Recipe not found", "error");
          return;
        }

        // Set current recipe
        currentRecipeData = recipe.data;
        currentRecipeId = recipeId;

        // Show expanded recipe view
        showExpandedRecipeView(recipe.data);

        // Add ingredients and steps to chat
        addRecipeToChat(recipe.data);

        // Update active card
        updateRecipeCards();
      }

      function showExpandedRecipeView(recipeData) {
        const expandedView = document.getElementById("expandedRecipeView");
        const titleElement = document.getElementById("expandedRecipeTitle");
        const metaElement = document.getElementById("expandedRecipeMeta");
        const ingredientsElement = document.getElementById("ingredientList");
        const flowchartElement = document.getElementById("expandedFlowchart");

        // Show the expanded view
        expandedView.classList.add("active");

        // Update title
        const recipeName =
          recipeData.recipeName || recipeData.scrapedTitle || "Recipe";
        titleElement.textContent = recipeName;

        // Update metadata
        const ingredientCount = recipeData.ingredients?.length || 0;
        const actionCount = recipeData.actions?.length || 0;
        metaElement.innerHTML = `
          <span>${ingredientCount} ingredients</span>
          <span>•</span>
          <span>${actionCount} steps</span>
          <span>•</span>
          <span>${new Date().toLocaleDateString()}</span>
        `;

        // Update ingredients
        if (recipeData.ingredients && recipeData.ingredients.length > 0) {
          ingredientsElement.innerHTML = recipeData.ingredients
            .map(
              (ingredient) => `
              <div class="ingredient-item">
                <strong>${ingredient.quantity}</strong> ${ingredient.name}
              </div>
            `
            )
            .join("");
        } else {
          ingredientsElement.innerHTML =
            '<p style="color: #86868b;">No ingredients available</p>';
        }

        // Render flowchart
        if (recipeData.mermaidDiagram) {
          renderExpandedFlowchart(recipeData.mermaidDiagram);
        } else {
          flowchartElement.innerHTML =
            '<p style="color: #86868b;">No flowchart available</p>';
        }
      }

      function renderExpandedFlowchart(mermaidCode) {
        const flowchartElement = document.getElementById("expandedFlowchart");
        const diagramId = "expanded-mermaid-diagram-" + Date.now();

        // Clear existing content
        flowchartElement.innerHTML = "";

        // Create container for the diagram
        const diagramContainer = document.createElement("div");
        diagramContainer.id = diagramId;
        flowchartElement.appendChild(diagramContainer);

        // Render the Mermaid diagram
        setTimeout(async () => {
          try {
            const { svg } = await mermaid.render(
              diagramId + "-svg",
              mermaidCode
            );
            diagramContainer.innerHTML = svg;
          } catch (error) {
            console.error("Mermaid rendering error:", error);
            diagramContainer.innerHTML = `<div style="color: #ff3b30; padding: 16px; background: #fff5f5; border: 1px solid #fecaca; border-radius: 8px;">
              <strong>Error rendering diagram:</strong><br>
              ${error.message}
            </div>`;
          }
        }, 200);
      }

      function addRecipeToChat(recipeData) {
        const chatMessages = document.getElementById("chatMessages");

        // Clear welcome message
        const welcomeMessage = document.querySelector(".welcome-message");
        if (welcomeMessage) {
          welcomeMessage.remove();
        }

        // Add ingredients message
        if (recipeData.ingredients && recipeData.ingredients.length > 0) {
          const ingredientsText = recipeData.ingredients
            .map((ingredient) => `• ${ingredient.quantity} ${ingredient.name}`)
            .join("\n");

          addMessage(
            `<h4>🥘 Ingredients</h4><pre style="white-space: pre-wrap; font-family: inherit;">${ingredientsText}</pre>`,
            "assistant"
          );
        }

        // Add steps message
        if (recipeData.actions && recipeData.actions.length > 0) {
          const stepsText = recipeData.actions
            .map(
              (action, index) =>
                `${index + 1}. ${action.name} (${action.duration} min)\n   ${
                  action.description
                }`
            )
            .join("\n\n");

          addMessage(
            `<h4>👨‍🍳 Cooking Steps</h4><pre style="white-space: pre-wrap; font-family: inherit;">${stepsText}</pre>`,
            "assistant"
          );
        }
      }

      function deleteRecipe(recipeId) {
        if (!confirm("Are you sure you want to delete this recipe?")) return;

        const savedRecipes = getSavedRecipes();
        const updatedRecipes = savedRecipes.filter((r) => r.id !== recipeId);

        localStorage.setItem(
          `savedRecipes_${deviceId}`,
          JSON.stringify(updatedRecipes)
        );

        if (currentRecipeId === recipeId) {
          currentRecipeData = null;
          currentRecipeId = null;
        }

        updateRecipeCards();
        showToast("Recipe deleted successfully", "success");
      }

      function downloadRecipe(recipeId) {
        const savedRecipes = getSavedRecipes();
        const recipe = savedRecipes.find((r) => r.id === recipeId);

        if (!recipe) {
          showToast("Recipe not found", "error");
          return;
        }

        downloadMermaidCode(recipe.data.mermaidDiagram, recipe.name);
      }

      // Utility functions
      function downloadMermaidCode(mermaidCode, filename = "recipe-flowchart") {
        if (!mermaidCode) {
          showToast("No Mermaid code available to download.", "error");
          return;
        }

        const blob = new Blob([mermaidCode], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${filename
          .replace(/[^a-z0-9]/gi, "_")
          .toLowerCase()}.mmd`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast("Flowchart code downloaded successfully!", "success");
      }

      function toggleRawCode(mermaidCode) {
        const codeHtml = `
          <div style="background: #1a1a1a; color: #f0f0f0; padding: 16px; border-radius: 8px; margin-top: 12px; font-family: monospace; font-size: 12px; overflow-x: auto;">
            <pre>${escapeHtml(mermaidCode)}</pre>
          </div>
        `;

        addMessage(`<h4>🔧 Raw Mermaid Code</h4>${codeHtml}`, "assistant");
      }

      function loadExampleRecipe() {
        const exampleRecipe = `Mapo Tofu

Ingredients:
- 1 block (14 oz) soft tofu, cut into 1-inch cubes
- 1/2 lb ground pork
- 2 tbsp Sichuan peppercorns
- 3 tbsp doubanjiang (fermented bean paste)
- 2 tbsp soy sauce
- 1 tbsp Shaoxing wine
- 1 tsp sugar
- 2 cloves garlic, minced
- 1 inch ginger, minced
- 2 green onions, chopped
- 1/4 cup chicken stock
- 2 tbsp cornstarch mixed with 2 tbsp water
- 2 tbsp vegetable oil

Instructions:
1. Heat oil in a wok over medium-high heat
2. Add ground pork and cook until browned
3. Add garlic, ginger, and Sichuan peppercorns, stir-fry for 30 seconds
4. Add doubanjiang and stir-fry for 1 minute
5. Add chicken stock, soy sauce, Shaoxing wine, and sugar
6. Bring to a boil and add tofu cubes
7. Simmer for 5 minutes, gently stirring occasionally
8. Add cornstarch slurry and stir until sauce thickens
9. Garnish with green onions and serve over rice`;

        sendExampleMessage(exampleRecipe);
      }

      // Chat input handling
      function setupChatInput() {
        const chatInput = document.getElementById("chatInput");

        chatInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // Auto-resize textarea
        chatInput.addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 200) + "px";
        });
      }

      // Toast notification functions
      function showToast(message, type = "info", duration = 4000) {
        // Remove any existing toast
        const existingToast = document.querySelector(".toast");
        if (existingToast) {
          existingToast.remove();
        }

        // Create new toast
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;

        document.body.appendChild(toast);

        // Trigger animation
        setTimeout(() => {
          toast.classList.add("show");
        }, 100);

        // Auto remove
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            if (toast.parentNode) {
              toast.remove();
            }
          }, 300);
        }, duration);
      }

      // Test function for Mermaid rendering
      window.testMermaid = async function () {
        const testDiagram = `graph TD;
          A[Start] --> B[Process];
          B --> C[End];`;

        console.log("Testing Mermaid rendering...");
        try {
          const { svg } = await mermaid.render("test-diagram", testDiagram);
          console.log("Test successful!", svg);
          return svg;
        } catch (error) {
          console.error("Test failed:", error);
          return null;
        }
      };

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        initializeStorage();
        setupChatInput();
        processUrlPath();
      });

      // URL path processing (for direct recipe URLs)
      async function processUrlPath() {
        const currentPath = window.location.pathname;

        if (
          currentPath &&
          currentPath.length > 1 &&
          (currentPath.startsWith("/http://") ||
            currentPath.startsWith("/https://"))
        ) {
          const recipeUrl = currentPath.substring(1); // Remove leading slash
          console.log("🔗 Recipe URL detected in path:", recipeUrl);

          // Prefill the chat input with the URL
          const chatInput = document.getElementById("chatInput");
          if (chatInput) {
            chatInput.value = recipeUrl;
          }

          // Clear welcome message and process
          clearWelcomeMessage();
          await processUserMessage(recipeUrl);

          // Clean up the URL
          const newUrl =
            window.location.protocol + "//" + window.location.host + "/";
          window.history.replaceState({}, document.title, newUrl);
        }
      }
    </script>
  </body>
</html>

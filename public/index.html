<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recipe Flowchart Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        min-height: 100vh;
        padding: 0;
        overflow-x: hidden;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        box-shadow: 0 32px 64px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(255, 255, 255, 0.2);
        overflow: hidden;
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        color: white;
        padding: 60px 40px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
      }

      .header-content {
        position: relative;
        z-index: 1;
      }

      .header h1 {
        font-size: 3.5em;
        margin-bottom: 20px;
        font-weight: 700;
        letter-spacing: -0.02em;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        background: linear-gradient(45deg, #ffffff, #f8f9fa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header p {
        font-size: 1.3em;
        opacity: 0.95;
        font-weight: 400;
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.6;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .content {
        padding: 60px 40px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
      }

      .input-section {
        margin-bottom: 60px;
      }

      .input-group {
        margin-bottom: 32px;
      }

      label {
        display: block;
        margin-bottom: 12px;
        font-weight: 600;
        color: #1a202c;
        font-size: 1.1em;
        letter-spacing: -0.01em;
      }

      textarea {
        width: 100%;
        min-height: 240px;
        padding: 24px;
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 16px;
        line-height: 1.6;
        resize: vertical;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }

      textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      textarea::placeholder {
        color: #a0aec0;
        font-style: italic;
      }

      input[type="url"]:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .file-upload {
        position: relative;
        display: inline-block;
        cursor: pointer;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 16px 32px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        border: none;
        overflow: hidden;
      }

      .file-upload::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
      }

      .file-upload:hover::before {
        left: 100%;
      }

      .file-upload:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
      }

      .file-upload input[type="file"] {
        position: absolute;
        left: -9999px;
      }

      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 18px 36px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin-right: 12px;
        margin-bottom: 12px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 28px rgba(102, 126, 234, 0.4);
      }

      .btn:active {
        transform: translateY(-1px);
      }

      .btn:disabled {
        background: linear-gradient(135deg, #cbd5e0, #a0aec0);
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .btn:disabled::before {
        display: none;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 60px 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        margin: 40px 0;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .spinner {
        border: 4px solid rgba(102, 126, 234, 0.1);
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading p {
        font-size: 1.2em;
        color: #4a5568;
        font-weight: 500;
        margin: 0;
      }

      .result-section {
        margin-top: 60px;
        padding-top: 60px;
        border-top: 1px solid rgba(226, 232, 240, 0.8);
        background: rgba(255, 255, 255, 0.6);
        border-radius: 20px;
        padding: 40px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      }

      .result-section h2 {
        color: #1a202c;
        margin-bottom: 32px;
        font-size: 2.2em;
        font-weight: 700;
        letter-spacing: -0.02em;
        text-align: center;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .mermaid-container {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        padding: 32px;
        margin-bottom: 32px;
        overflow-x: auto;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.8);
        backdrop-filter: blur(10px);
      }

      .ingredients-list,
      .actions-list {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 16px;
        padding: 32px;
        margin-bottom: 32px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.8);
        backdrop-filter: blur(10px);
      }

      .ingredients-list h3,
      .actions-list h3 {
        color: #1a202c;
        margin-bottom: 24px;
        font-size: 1.5em;
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .ingredient-item,
      .action-item {
        background: rgba(255, 255, 255, 0.9);
        padding: 20px 24px;
        margin-bottom: 16px;
        border-radius: 12px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .ingredient-item:hover,
      .action-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      }

      .action-item {
        border-left-color: #f093fb;
      }

      .error {
        background: linear-gradient(135deg, #fed7d7, #feb2b2);
        color: #c53030;
        padding: 24px;
        border-radius: 16px;
        border-left: 4px solid #e53e3e;
        margin: 32px 0;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(229, 62, 62, 0.2);
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 1000;
      }

      .success {
        background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
        color: #22543d;
        padding: 24px;
        border-radius: 16px;
        border-left: 4px solid #38a169;
        margin: 32px 0;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(56, 161, 105, 0.2);
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 1000;
      }

      .example-recipe {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 16px;
        padding: 32px;
        margin-bottom: 32px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.1);
      }

      .example-recipe h4 {
        color: #1a202c;
        margin-bottom: 16px;
        font-size: 1.3em;
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .example-recipe p {
        color: #4a5568;
        margin-bottom: 20px;
        line-height: 1.6;
      }

      .example-recipe button {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        margin-right: 12px;
        margin-bottom: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }

      .example-recipe button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
      }

      .example-recipe button.green {
        background: linear-gradient(135deg, #48bb78, #38a169);
        box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
      }

      .example-recipe button.green:hover {
        box-shadow: 0 4px 16px rgba(72, 187, 120, 0.4);
      }

      /* Table styling */
      #table-container table {
        border-collapse: collapse;
        width: 100%;
        margin: 0 auto;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      #table-container th,
      #table-container td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
        vertical-align: top;
      }

      #table-container th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #dee2e6;
      }

      #table-container .ingredient-cell {
        background-color: #e1f5fe;
        color: #01579b;
        font-weight: 500;
        border-left: 3px solid #01579b;
      }

      #table-container .step-cell {
        background-color: #fff3e0;
        color: #e65100;
        font-weight: 500;
        border-left: 3px solid #e65100;
      }

      #table-container .final-cell {
        background-color: #e8f5e8;
        color: #2e7d32;
        font-weight: 600;
        border-left: 3px solid #2e7d32;
        text-align: center;
      }

      #table-container .step-header {
        background-color: #f8f9fa;
        color: #495057;
        font-weight: 600;
        text-align: center;
        border-bottom: 2px solid #dee2e6;
      }

      #table-container tr:hover {
        background-color: #f5f5f5;
      }

      #table-container tr:hover .ingredient-cell,
      #table-container tr:hover .step-cell,
      #table-container tr:hover .final-cell {
        background-color: inherit;
      }

      /* Modal styles */
      .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 15px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        background: linear-gradient(135deg, #6f42c1, #5a32a3);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5em;
        font-weight: 300;
      }

      .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.3s ease;
      }

      .close:hover {
        opacity: 0.7;
      }

      .modal-body {
        padding: 30px;
        max-height: 60vh;
        overflow-y: auto;
      }

      .saved-recipes-list {
        display: grid;
        gap: 15px;
      }

      .saved-recipe-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .saved-recipe-item:hover {
        background: #e9ecef;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .saved-recipe-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .saved-recipe-name {
        font-size: 1.2em;
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      .saved-recipe-date {
        font-size: 0.9em;
        color: #666;
        margin: 0;
      }

      .saved-recipe-preview {
        color: #666;
        font-size: 0.9em;
        margin: 10px 0;
        line-height: 1.4;
      }

      .saved-recipe-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .saved-recipe-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
      }

      .saved-recipe-btn.load {
        background: #667eea;
        color: white;
      }

      .saved-recipe-btn.load:hover {
        background: #5a6fd8;
      }

      .saved-recipe-btn.delete {
        background: #dc3545;
        color: white;
      }

      .saved-recipe-btn.delete:hover {
        background: #c82333;
      }

      .no-saved-recipes {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .no-saved-recipes p {
        font-size: 1.1em;
        margin: 0;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .container {
          margin: 10px;
          border-radius: 16px;
        }

        .header {
          padding: 40px 20px;
        }

        .header h1 {
          font-size: 2.5em;
        }

        .header p {
          font-size: 1.1em;
        }

        .content {
          padding: 40px 20px;
        }

        .btn {
          width: 100%;
          margin-right: 0;
          margin-bottom: 12px;
        }

        .file-upload {
          width: 100%;
          text-align: center;
        }

        textarea {
          min-height: 200px;
          padding: 20px;
        }

        .mermaid-container,
        .ingredients-list,
        .actions-list {
          padding: 20px;
        }

        .result-section {
          padding: 20px;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 2em;
        }

        .header p {
          font-size: 1em;
        }

        .content {
          padding: 20px 15px;
        }

        .btn {
          padding: 16px 24px;
          font-size: 14px;
        }
      }

      /* Smooth scrolling */
      html {
        scroll-behavior: smooth;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #5a6fd8, #6b46a3);
      }

      /* Toast notification */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 12px;
        padding: 16px 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 10000;
        transform: translateX(400px);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 400px;
        font-weight: 500;
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast.success {
        border-left: 4px solid #38a169;
        color: #22543d;
      }

      .toast.error {
        border-left: 4px solid #e53e3e;
        color: #c53030;
      }

      .toast.info {
        border-left: 4px solid #3182ce;
        color: #2c5282;
      }

      @media (max-width: 768px) {
        .toast {
          right: 10px;
          left: 10px;
          max-width: none;
          transform: translateY(-100px);
        }

        .toast.show {
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-content">
          <h1>üç≥ Recipe Flowchart Generator</h1>
          <p>Transform your recipes into beautiful Mermaid flowcharts using AI</p>
        </div>
      </div>

      <div class="content">
        <div class="input-section">
          <div class="example-recipe">
            <h4>üìù Try with the example recipe:</h4>
            <p>
              Load the Mapo Tofu recipe and generate a flowchart, or load the
              pre-generated example directly.
            </p>
            <button onclick="loadExampleRecipe()">üìù Load Recipe Text</button>
            <button onclick="loadExampleFlowchart()" class="green">
              üöÄ Load Example Flowchart
            </button>
          </div>

          <div class="input-group">
            <label for="recipeInput">üìã Enter your recipe or recipe URL:</label>
            <textarea
              id="recipeInput"
              placeholder="Paste your recipe text here, or enter a recipe URL (e.g., https://example.com/recipe)... Include ingredients and instructions for best results."
            ></textarea>
            <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
              üí° <strong>Smart Detection:</strong> We'll automatically detect if you've entered a recipe or a URL and process it accordingly. Supports most recipe websites including AllRecipes, Food Network, BBC Good Food, and more.
            </div>
          </div>

          <div class="input-group">
            <label>üìÅ Or upload a recipe file:</label>
            <div class="file-upload">
              <input
                type="file"
                id="recipeFile"
                accept=".txt,.md,.doc,.docx"
                onchange="handleFileUpload()"
              />
              Choose File
            </div>
            <span id="fileName" style="margin-left: 10px; color: #666"></span>
          </div>

          <button class="btn" onclick="processRecipe()" id="processBtn">
            üöÄ Generate Flowchart
          </button>
          <button
            class="btn"
            onclick="processRecipeTable()"
            id="processTableBtn"
            style="background: #17a2b8"
          >
            üìä Generate Table
          </button>
          <button class="btn" onclick="saveCurrentRecipe()" id="saveBtn" style="background: #28a745">
            üíæ Save Recipe
          </button>
          <button class="btn" onclick="showSavedRecipes()" id="browseBtn" style="background: #6f42c1">
            üìö Browse Saved
          </button>
          <button class="btn" onclick="clearAll()" style="background: #6c757d">
            üóëÔ∏è Clear
          </button>
        </div>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Processing your recipe with AI...</p>
        </div>

        <div class="result-section" id="resultSection" style="display: none">
          <h2 id="recipeTitle">üìä Recipe Flowchart</h2>

          <div class="flowchart-controls" style="margin-bottom: 20px">
            <button
              class="btn"
              onclick="downloadCurrent()"
              id="downloadBtn"
              style="background: #28a745"
            >
              üíæ Download
            </button>
            <button
              class="btn"
              onclick="toggleRawCode()"
              id="toggleCodeBtn"
              style="background: #17a2b8"
            >
              üîç Show/Hide Raw Code
            </button>
          </div>

          <div class="mermaid-container">
            <div id="mermaid-diagram"></div>
          </div>

          <div
            class="mermaid-code-container"
            id="mermaidCodeContainer"
            style="display: none"
          >
            <h3>üîß Raw Mermaid Code (for debugging)</h3>
            <pre
              id="mermaidCodeDisplay"
              style="
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                overflow-x: auto;
                font-family: 'Courier New', monospace;
                font-size: 12px;
                border: 1px solid #dee2e6;
              "
            ></pre>
          </div>

          <div class="ingredients-list" id="ingredientsList"></div>
          <div class="actions-list" id="actionsList"></div>
        </div>

        <div id="errorMessage" class="error" style="display: none"></div>
      </div>
    </div>

    <!-- Saved Recipes Modal -->
    <div id="savedRecipesModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>üìö Your Saved Recipes</h2>
          <span class="close" onclick="closeSavedRecipesModal()">&times;</span>
        </div>
        <div class="modal-body">
          <div id="savedRecipesList" class="saved-recipes-list">
            <!-- Saved recipes will be populated here -->
          </div>
          <div id="noSavedRecipes" class="no-saved-recipes" style="display: none;">
            <p>No saved recipes found. Generate and save some recipes to see them here!</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Initialize Mermaid
      mermaid.initialize({
        startOnLoad: false,
        theme: "default",
        flowchart: {
          useMaxWidth: true,
          htmlLabels: true,
        },
      });

      let uploadedFile = null;
      let currentMermaidCode = null;
      let currentHtmlTable = null;
      let currentRecipeName = null;
      let currentViewMode = "flowchart"; // 'flowchart' or 'table'
      let currentRecipeData = null; // Store the complete recipe data for saving
      let deviceId = null; // Device identifier for localStorage keys

      // Intelligent input detection
      function detectInputType(input) {
        const trimmedInput = input.trim();
        
        // Check if it's a URL
        if (isValidUrl(trimmedInput)) {
          return 'url';
        }
        
        // Check if it looks like a recipe (has common recipe keywords)
        const recipeKeywords = [
          'ingredients', 'instructions', 'directions', 'recipe', 'cook', 'bake', 'fry', 'boil',
          'tablespoon', 'teaspoon', 'cup', 'pound', 'ounce', 'gram', 'kilogram', 'liter',
          'preheat', 'mix', 'combine', 'add', 'stir', 'whisk', 'beat', 'fold', 'knead',
          'season', 'salt', 'pepper', 'sugar', 'flour', 'butter', 'oil', 'eggs', 'milk'
        ];
        
        const lowerInput = trimmedInput.toLowerCase();
        const keywordCount = recipeKeywords.filter(keyword => lowerInput.includes(keyword)).length;
        
        // If it has multiple recipe keywords and is reasonably long, it's likely a recipe
        if (keywordCount >= 3 && trimmedInput.length > 50) {
          return 'recipe';
        }
        
        // If it's very short and doesn't look like a URL, it's probably invalid
        if (trimmedInput.length < 20) {
          return 'invalid';
        }
        
        // Default to recipe if we can't determine
        return 'recipe';
      }

      // URL validation helper
      function isValidUrl(string) {
        try {
          const url = new URL(string);
          return ['http:', 'https:'].includes(url.protocol);
        } catch (_) {
          return false;
        }
      }

      // Initialize device ID and localStorage
      function initializeStorage() {
        // Get device ID from cookie or generate one
        const cookies = document.cookie.split(';');
        let foundDeviceId = null;
        
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'deviceId') {
            foundDeviceId = value;
            break;
          }
        }
        
        if (!foundDeviceId) {
          // Generate a device ID if not found
          foundDeviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          document.cookie = `deviceId=${foundDeviceId}; max-age=${365 * 24 * 60 * 60}; path=/`;
        }
        
        deviceId = foundDeviceId;
        console.log('üÜî Device ID initialized:', deviceId);
      }

      // localStorage management functions
      function getStorageKey(key) {
        return `recipe_${deviceId}_${key}`;
      }

      function saveRecipeToStorage(recipeData) {
        try {
          const storageKey = getStorageKey('recipes');
          const existingRecipes = JSON.parse(localStorage.getItem(storageKey) || '[]');
          
          const recipeToSave = {
            id: Date.now().toString(),
            name: recipeData.recipeName || recipeData.scrapedTitle || 'Untitled Recipe',
            data: recipeData,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          
          existingRecipes.unshift(recipeToSave); // Add to beginning
          
          // Limit to 50 saved recipes
          if (existingRecipes.length > 50) {
            existingRecipes.splice(50);
          }
          
          localStorage.setItem(storageKey, JSON.stringify(existingRecipes));
          console.log('üíæ Recipe saved to localStorage:', recipeToSave.name);
          return recipeToSave.id;
        } catch (error) {
          console.error('‚ùå Error saving recipe to localStorage:', error);
          return null;
        }
      }

      function getSavedRecipes() {
        try {
          const storageKey = getStorageKey('recipes');
          return JSON.parse(localStorage.getItem(storageKey) || '[]');
        } catch (error) {
          console.error('‚ùå Error loading recipes from localStorage:', error);
          return [];
        }
      }

      function deleteRecipeFromStorage(recipeId) {
        try {
          const storageKey = getStorageKey('recipes');
          const existingRecipes = JSON.parse(localStorage.getItem(storageKey) || '[]');
          const filteredRecipes = existingRecipes.filter(recipe => recipe.id !== recipeId);
          localStorage.setItem(storageKey, JSON.stringify(filteredRecipes));
          console.log('üóëÔ∏è Recipe deleted from localStorage:', recipeId);
          return true;
        } catch (error) {
          console.error('‚ùå Error deleting recipe from localStorage:', error);
          return false;
        }
      }

      function loadExampleRecipe() {
        const exampleRecipe = `MAPO TOFU

INGREDIENTS
‚ñ¢ 1/2 cup oil (divided)
‚ñ¢ 1-2 fresh Thai bird chili peppers (thinly sliced)
‚ñ¢ 6-8 dried red chilies (roughly chopped)
‚ñ¢ 1/2- 1 1/2 tablespoons Sichuan peppercorns (powdered or finely ground, reserving 1/4 teaspoon for garnish at the end; if you want a milder flavor use 1/2 or 1 teaspoon ground Sichuan peppercorn)
‚ñ¢ 3 tablespoons ginger (finely minced)
‚ñ¢ 3 tablespoons garlic (finely minced)
‚ñ¢ 8 ounces ground pork
‚ñ¢ 1-2 tablespoons spicy bean sauce (depending on your desired salt/spice levels)
‚ñ¢ 2/3 cup low sodium chicken broth (or water)
‚ñ¢ 1 pound silken tofu (cut into 1 inch/2.5cm cubes)
‚ñ¢ 1/4 cup water
‚ñ¢ 1 1/2 teaspoons cornstarch
‚ñ¢ 1/4 teaspoon sesame oil (optional)
‚ñ¢ 1/4 teaspoon sugar (optional)
‚ñ¢ 1 scallion (finely chopped)

INSTRUCTIONS

First, we toast the chilies. If you have homemade toasted chili oil, you can skip this step. Heat your wok or a small saucepan over low heat. Add half of the oil and throw in the fresh and dried peppers. Stir occasionally and heat until fragrant, about 5 minutes, ensuring that the peppers don't burn. Remove from heat and set aside.
Heat the remaining half of the oil in your wok over medium heat. Add the ginger. After 1 minute, add the garlic. Fry for another minute, and then turn up the heat to high and add the ground pork. Break up the meat and fry it until it's cooked through. Add your ground Sichuan peppercorns and stir for about 15-30 seconds, taking care to not let it burn, as it will turn bitter if it does.
Add the spicy bean sauce to the mixture and stir it in well. Add the chicken broth to the wok and stir. Let this simmer for a minute or so. While that's happening, ready your tofu and combine the water and cornstarch in a small bowl.
Add the cornstarch mixture to your sauce and stir. Let it bubble away until the sauce starts to thicken. (If it gets too thick, splash in a little more water or chicken stock.)
Then add your chili oil from before‚Äîpeppers and all! If you are using homemade chili oil, ONLY use the standing oil, as it's likely that you have salted it and you only want the oil, not additional salt. Stir the oil into the sauce, and add the tofu. Use your spatula to gently toss the tofu in the sauce. Let everything cook for 3-5 minutes. Add the sesame oil and sugar (if using) along with the scallions and stir until the scallions are just wilted.
Serve with a last sprinkle of Sichuan peppercorn powder as a garnish if desired.`;

        document.getElementById("recipeInput").value = exampleRecipe;
      }

      async function loadExampleFlowchart() {
        const processBtn = document.getElementById("processBtn");
        const loading = document.getElementById("loading");
        const resultSection = document.getElementById("resultSection");
        const errorMessage = document.getElementById("errorMessage");

        // Show loading state
        processBtn.disabled = true;
        loading.style.display = "block";
        resultSection.style.display = "none";
        errorMessage.style.display = "none";

        try {
          const response = await fetch("/api/example-flowchart");

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error || "Failed to load example flowchart"
            );
          }

          const result = await response.json();
          displayResult(result);
        } catch (error) {
          showError(`Error: ${error.message}`);
        } finally {
          processBtn.disabled = false;
          loading.style.display = "none";
        }
      }

      function handleFileUpload() {
        const fileInput = document.getElementById("recipeFile");
        const fileName = document.getElementById("fileName");

        if (fileInput.files.length > 0) {
          uploadedFile = fileInput.files[0];
          fileName.textContent = `Selected: ${uploadedFile.name}`;
        } else {
          uploadedFile = null;
          fileName.textContent = "";
        }
      }

      async function processRecipe() {
        const recipeInput = document.getElementById("recipeInput").value.trim();
        const processBtn = document.getElementById("processBtn");
        const processTableBtn = document.getElementById("processTableBtn");
        const loading = document.getElementById("loading");
        const resultSection = document.getElementById("resultSection");
        const errorMessage = document.getElementById("errorMessage");

        if (!recipeInput && !uploadedFile) {
          showError("Please enter a recipe, upload a file, or provide a recipe URL.");
          return;
        }

        // If we have text input, validate it
        if (recipeInput) {
          const inputType = detectInputType(recipeInput);
          console.log(`üîç Detected input type: ${inputType}`);
          
          if (inputType === 'invalid') {
            showError("The input appears to be too short or doesn't look like a recipe or URL. Please provide a complete recipe or a valid recipe URL.");
            return;
          }
          // Continue with processing (server will handle URL vs recipe detection)
        }

        // Show loading state
        processBtn.disabled = true;
        processTableBtn.disabled = true;
        loading.style.display = "block";
        resultSection.style.display = "none";
        errorMessage.style.display = "none";

        try {
          let response;

          if (uploadedFile) {
            // Upload file
            const formData = new FormData();
            formData.append("recipeFile", uploadedFile);

            response = await fetch("/api/upload-recipe", {
              method: "POST",
              body: formData,
            });
          } else {
            // Process text (recipe input)
            response = await fetch("/api/process-recipe", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ recipeText: recipeInput }),
            });
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to process recipe");
          }

          const result = await response.json();
          currentViewMode = "flowchart";
          displayResult(result);
        } catch (error) {
          showError(`Error: ${error.message}`);
        } finally {
          processBtn.disabled = false;
          processTableBtn.disabled = false;
          loading.style.display = "none";
        }
      }


      async function processRecipeTable() {
        const recipeInput = document.getElementById("recipeInput").value.trim();
        const processBtn = document.getElementById("processBtn");
        const processTableBtn = document.getElementById("processTableBtn");
        const loading = document.getElementById("loading");
        const resultSection = document.getElementById("resultSection");
        const errorMessage = document.getElementById("errorMessage");

        if (!recipeInput && !uploadedFile) {
          showError("Please enter a recipe, upload a file, or provide a recipe URL.");
          return;
        }

        // If we have text input, validate it
        if (recipeInput) {
          const inputType = detectInputType(recipeInput);
          
          if (inputType === 'url') {
            // For now, show error for URL + table combination
            showError("Table view is not yet supported for recipe URLs. Please use the flowchart view.");
            return;
          } else if (inputType === 'invalid') {
            showError("The input appears to be too short or doesn't look like a recipe or URL. Please provide a complete recipe or a valid recipe URL.");
            return;
          }
          // Continue with processing (server will handle URL vs recipe detection)
        }

        // Show loading state
        processBtn.disabled = true;
        processTableBtn.disabled = true;
        loading.style.display = "block";
        resultSection.style.display = "none";
        errorMessage.style.display = "none";

        try {
          let response;

          if (uploadedFile) {
            // For file uploads, we'll need to read the file content
            const fileContent = await readFileContent(uploadedFile);
            response = await fetch("/api/process-recipe-table", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ recipeText: fileContent }),
            });
          } else {
            // Process text (recipe input)
            response = await fetch("/api/process-recipe-table", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ recipeText: recipeInput }),
            });
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error || "Failed to process recipe to table"
            );
          }

          const result = await response.json();
          currentViewMode = "table";
          displayTableResult(result);
        } catch (error) {
          showError(`Error: ${error.message}`);
        } finally {
          processBtn.disabled = false;
          processTableBtn.disabled = false;
          loading.style.display = "none";
        }
      }

      function readFileContent(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = (e) => reject(e);
          reader.readAsText(file);
        });
      }

      function displayResult(result) {
        const resultSection = document.getElementById("resultSection");
        const mermaidContainer = document.getElementById("mermaid-diagram");
        const ingredientsList = document.getElementById("ingredientsList");
        const actionsList = document.getElementById("actionsList");
        const recipeTitle = document.getElementById("recipeTitle");

        // Store the Mermaid code and recipe name for download
        currentMermaidCode = result.mermaidDiagram;
        currentRecipeName = result.recipeName || result.scrapedTitle || "recipe";
        currentRecipeData = result; // Store complete recipe data for saving

        // Update the recipe title to show the human-readable name
        const displayName = result.recipeName || result.scrapedTitle || "Recipe";
        recipeTitle.textContent = `üç≥ ${displayName}`;

        // Clear the container and render new Mermaid diagram
        mermaidContainer.innerHTML = "";

        // Create a unique ID for this diagram
        const diagramId = "mermaid-diagram-" + Date.now();
        mermaidContainer.innerHTML = `<div id="${diagramId}">${result.mermaidDiagram}</div>`;

        // Initialize Mermaid with the new content
        mermaid.init(undefined, document.getElementById(diagramId));

        // Display ingredients if available
        if (result.ingredients && result.ingredients.length > 0) {
          ingredientsList.innerHTML = `
            <h3>ü•ò Ingredients (${result.ingredients.length})</h3>
            ${result.ingredients
              .map(
                (ingredient) => `
              <div class="ingredient-item">
                <strong>${ingredient.name}</strong> <span style="color: #667eea; font-weight: 600;">${ingredient.quantity || 'No quantity specified'}</span>
                <div style="color: #666; font-size: 0.9em; margin-top: 4px;">${ingredient.description}</div>
              </div>
            `
              )
              .join("")}
          `;
        } else {
          ingredientsList.innerHTML = "";
        }

        // Display actions if available
        if (result.actions && result.actions.length > 0) {
          actionsList.innerHTML = `
            <h3>üë®‚Äçüç≥ Cooking Actions (${result.actions.length})</h3>
            ${result.actions
              .map(
                (action) => `
              <div class="action-item">
                <strong>${
                  action.name
                }</strong> <span style="color: #ff6b6b; font-size: 0.9em;">(${
                  action.duration
                } min)</span>
                <div style="color: #666; font-size: 0.9em; margin-top: 4px;">${
                  action.description
                }</div>
                <div style="color: #888; font-size: 0.8em; margin-top: 4px;">
                  Inputs: ${action.inputIngredients.join(
                    ", "
                  )} ‚Üí Outputs: ${action.outputIngredients.join(", ")}
                </div>
              </div>
            `
              )
              .join("")}
          `;
        } else {
          actionsList.innerHTML = "";
        }

        // Show source information if available
        if (result.originalUrl) {
          const sourceInfo = document.createElement("div");
          sourceInfo.style.cssText = `
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9em;
          `;
          sourceInfo.innerHTML = `
            <strong>üìÑ Source:</strong> <a href="${result.originalUrl}" target="_blank" style="color: #17a2b8;">${result.originalUrl}</a>
            ${result.scrapedTitle ? `<br><strong>üìù Title:</strong> ${result.scrapedTitle}` : ''}
          `;
          resultSection.insertBefore(sourceInfo, resultSection.firstChild);
        }

        resultSection.style.display = "block";
      }

      function displayTableResult(result) {
        const resultSection = document.getElementById("resultSection");
        const mermaidContainer = document.getElementById("mermaid-diagram");
        const ingredientsList = document.getElementById("ingredientsList");
        const actionsList = document.getElementById("actionsList");
        const recipeTitle = document.getElementById("recipeTitle");

        // Store the HTML table and recipe name for download
        currentHtmlTable = result.htmlTable;
        currentRecipeName = result.recipeName || "recipe";

        // Update the recipe title to show the human-readable name
        const displayName = result.recipeName || "Recipe";
        recipeTitle.textContent = `üç≥ ${displayName}`;

        // Hide Mermaid container and show HTML table
        mermaidContainer.style.display = "none";

        // Create or update table container
        let tableContainer = document.getElementById("table-container");
        if (!tableContainer) {
          tableContainer = document.createElement("div");
          tableContainer.id = "table-container";
          tableContainer.style.cssText = `
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-x: auto;
          `;
          mermaidContainer.parentNode.insertBefore(
            tableContainer,
            mermaidContainer
          );
        }

        tableContainer.innerHTML = result.htmlTable;
        tableContainer.style.display = "block";

        // Display ingredients if available
        if (result.ingredients && result.ingredients.length > 0) {
          ingredientsList.innerHTML = `
            <h3>ü•ò Ingredients (${result.ingredients.length})</h3>
            ${result.ingredients
              .map(
                (ingredient) => `
              <div class="ingredient-item">
                <strong>${ingredient.name}</strong> <span style="color: #667eea; font-weight: 600;">${ingredient.quantity || 'No quantity specified'}</span>
                <div style="color: #666; font-size: 0.9em; margin-top: 4px;">${ingredient.description}</div>
              </div>
            `
              )
              .join("")}
          `;
        } else {
          ingredientsList.innerHTML = "";
        }

        // Display steps if available
        if (result.steps && result.steps.length > 0) {
          actionsList.innerHTML = `
            <h3>üë®‚Äçüç≥ Cooking Steps (${result.steps.length})</h3>
            ${result.steps
              .map(
                (step) => `
              <div class="action-item">
                <strong>${
                  step.name
                }</strong> <span style="color: #ff6b6b; font-size: 0.9em;">(${
                  step.duration
                } min)</span>
                <div style="color: #666; font-size: 0.9em; margin-top: 4px;">${
                  step.description
                }</div>
                <div style="color: #888; font-size: 0.8em; margin-top: 4px;">
                  Involves: ${step.involvedIngredients.join(", ")}
                </div>
              </div>
            `
              )
              .join("")}
          `;
        } else {
          actionsList.innerHTML = "";
        }

        resultSection.style.display = "block";
      }

      // Toast notification functions
      function showToast(message, type = 'info', duration = 4000) {
        // Remove any existing toast
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
          existingToast.remove();
        }

        // Create new toast
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // Trigger animation
        setTimeout(() => {
          toast.classList.add('show');
        }, 100);
        
        // Auto remove
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            if (toast.parentNode) {
              toast.remove();
            }
          }, 300);
        }, duration);
      }

      function showError(message) {
        // Show both inline error and toast
        const errorMessage = document.getElementById("errorMessage");
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
        errorMessage.className = "error";
        
        // Also show toast notification
        showToast(message, 'error', 5000);
      }

      function downloadMermaidCode() {
        if (!currentMermaidCode) {
          showError("No Mermaid code available to download.");
          return;
        }

        try {
          const response = fetch("/api/download-mermaid", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              mermaidCode: currentMermaidCode,
              recipeName: currentRecipeName,
            }),
          });

          response
            .then((res) => {
              if (res.ok) {
                return res.blob();
              } else {
                throw new Error("Failed to download Mermaid code");
              }
            })
            .then((blob) => {
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.style.display = "none";
              a.href = url;
              a.download = `${currentRecipeName}_flowchart.mmd`;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
            })
            .catch((error) => {
              showError(`Error downloading file: ${error.message}`);
            });
        } catch (error) {
          showError(`Error downloading file: ${error.message}`);
        }
      }

      function downloadHtmlTable() {
        if (!currentHtmlTable) {
          showError("No HTML table available to download.");
          return;
        }

        try {
          const response = fetch("/api/download-table", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              htmlTable: currentHtmlTable,
              recipeName: currentRecipeName,
            }),
          });

          response
            .then((res) => {
              if (res.ok) {
                return res.blob();
              } else {
                throw new Error("Failed to download HTML table");
              }
            })
            .then((blob) => {
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.style.display = "none";
              a.href = url;
              a.download = `${currentRecipeName}_table.html`;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
            })
            .catch((error) => {
              showError(`Error downloading file: ${error.message}`);
            });
        } catch (error) {
          showError(`Error downloading file: ${error.message}`);
        }
      }

      function downloadCurrent() {
        if (currentViewMode === "flowchart") {
          downloadMermaidCode();
        } else if (currentViewMode === "table") {
          downloadHtmlTable();
        } else {
          showError("No content available to download.");
        }
      }

      function toggleRawCode() {
        const codeContainer = document.getElementById("mermaidCodeContainer");
        const codeDisplay = document.getElementById("mermaidCodeDisplay");
        const toggleBtn = document.getElementById("toggleCodeBtn");

        if (codeContainer.style.display === "none") {
          if (currentViewMode === "flowchart" && currentMermaidCode) {
            codeDisplay.textContent = currentMermaidCode;
            codeContainer.style.display = "block";
            toggleBtn.textContent = "üîç Hide Raw Code";
          } else if (currentViewMode === "table" && currentHtmlTable) {
            codeDisplay.innerHTML = currentHtmlTable;
            codeContainer.style.display = "block";
            toggleBtn.textContent = "üîç Hide Raw Code";
          } else {
            showError("No raw code available to display.");
          }
        } else {
          codeContainer.style.display = "none";
          toggleBtn.textContent = "üîç Show Raw Code";
        }
      }

      function clearAll() {
        document.getElementById("recipeInput").value = "";
        document.getElementById("recipeFile").value = "";
        document.getElementById("fileName").textContent = "";
        document.getElementById("resultSection").style.display = "none";
        document.getElementById("errorMessage").style.display = "none";
        document.getElementById("mermaidCodeContainer").style.display = "none";
        document.getElementById("toggleCodeBtn").textContent =
          "üîç Show Raw Code";
        document.getElementById("recipeTitle").textContent = "üìä Recipe Flowchart";

        // Hide table container if it exists
        const tableContainer = document.getElementById("table-container");
        if (tableContainer) {
          tableContainer.style.display = "none";
        }

        // Show Mermaid container
        document.getElementById("mermaid-diagram").style.display = "block";

        uploadedFile = null;
        currentMermaidCode = null;
        currentHtmlTable = null;
        currentRecipeName = null;
        currentRecipeData = null;
        currentViewMode = "flowchart";
      }

      // Save current recipe to localStorage
      function saveCurrentRecipe() {
        if (!currentRecipeData) {
          showError("No recipe to save. Please generate a recipe first.");
          return;
        }

        const recipeId = saveRecipeToStorage(currentRecipeData);
        if (recipeId) {
          const displayName = currentRecipeData.recipeName || currentRecipeData.scrapedTitle || "Recipe";
          showSuccess(`Recipe "${displayName}" saved successfully!`);
        } else {
          showError("Failed to save recipe. Please try again.");
        }
      }

      // Show saved recipes modal
      function showSavedRecipes() {
        const modal = document.getElementById("savedRecipesModal");
        const recipesList = document.getElementById("savedRecipesList");
        const noRecipes = document.getElementById("noSavedRecipes");
        
        const savedRecipes = getSavedRecipes();
        
        if (savedRecipes.length === 0) {
          recipesList.style.display = "none";
          noRecipes.style.display = "block";
        } else {
          noRecipes.style.display = "none";
          recipesList.style.display = "block";
          
          recipesList.innerHTML = savedRecipes.map(recipe => {
            const createdDate = new Date(recipe.createdAt).toLocaleDateString();
            const preview = recipe.data.ingredients ? 
              `${recipe.data.ingredients.length} ingredients, ${recipe.data.actions?.length || 0} actions` :
              'Recipe data available';
            
            return `
              <div class="saved-recipe-item">
                <div class="saved-recipe-header">
                  <h3 class="saved-recipe-name">${recipe.name}</h3>
                  <p class="saved-recipe-date">${createdDate}</p>
                </div>
                <div class="saved-recipe-preview">${preview}</div>
                <div class="saved-recipe-actions">
                  <button class="saved-recipe-btn load" onclick="loadSavedRecipe('${recipe.id}')">
                    üìñ Load Recipe
                  </button>
                  <button class="saved-recipe-btn delete" onclick="deleteSavedRecipe('${recipe.id}')">
                    üóëÔ∏è Delete
                  </button>
                </div>
              </div>
            `;
          }).join('');
        }
        
        modal.style.display = "block";
      }

      // Close saved recipes modal
      function closeSavedRecipesModal() {
        document.getElementById("savedRecipesModal").style.display = "none";
      }

      // Load a saved recipe
      function loadSavedRecipe(recipeId) {
        const savedRecipes = getSavedRecipes();
        const recipe = savedRecipes.find(r => r.id === recipeId);
        
        if (recipe) {
          currentRecipeData = recipe.data;
          displayResult(recipe.data);
          closeSavedRecipesModal();
          const displayName = recipe.data.recipeName || recipe.data.scrapedTitle || recipe.name;
          showSuccess(`Recipe "${displayName}" loaded successfully!`);
        } else {
          showError("Recipe not found. It may have been deleted.");
        }
      }

      // Delete a saved recipe
      function deleteSavedRecipe(recipeId) {
        if (confirm("Are you sure you want to delete this recipe? This action cannot be undone.")) {
          if (deleteRecipeFromStorage(recipeId)) {
            showSavedRecipes(); // Refresh the list
            showSuccess("Recipe deleted successfully!");
          } else {
            showError("Failed to delete recipe. Please try again.");
          }
        }
      }

      // Show success message
      function showSuccess(message) {
        // Show toast notification (primary method)
        showToast(message, 'success', 4000);
        
        // Also show inline message for consistency
        const errorMessage = document.getElementById("errorMessage");
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
        errorMessage.className = "success";
        
        setTimeout(() => {
          errorMessage.style.display = "none";
          errorMessage.className = "error"; // Reset to error class
        }, 4000);
      }

      // Close modal when clicking outside
      window.onclick = function(event) {
        const modal = document.getElementById("savedRecipesModal");
        if (event.target === modal) {
          closeSavedRecipesModal();
        }
      }

      // Process URL path on page load
      async function processUrlPath() {
        const currentPath = window.location.pathname;
        
        // Check if the path looks like a recipe URL (starts with http:// or https://)
        if (currentPath && currentPath.length > 1 && 
            (currentPath.startsWith('/http://') || currentPath.startsWith('/https://'))) {
          
          // Extract the URL from the path (remove the leading slash)
          const recipeUrl = currentPath.substring(1);
          console.log('üîó Recipe URL detected in path:', recipeUrl);
          
          // Prefill the text box with the URL
          const recipeInput = document.getElementById("recipeInput");
          if (recipeInput) {
            recipeInput.value = recipeUrl;
          }
          
          // Validate URL format
          if (!isValidUrl(recipeUrl)) {
            showError('Invalid URL format in path. Please provide a valid HTTP or HTTPS URL.');
            return;
          }
          
          // Show loading state
          const processBtn = document.getElementById("processBtn");
          const processTableBtn = document.getElementById("processTableBtn");
          const loading = document.getElementById("loading");
          const resultSection = document.getElementById("resultSection");
          const errorMessage = document.getElementById("errorMessage");
          
          processBtn.disabled = true;
          processTableBtn.disabled = true;
          loading.style.display = "block";
          resultSection.style.display = "none";
          errorMessage.style.display = "none";
          
          try {
            console.log('üåê Processing recipe URL from path...');
            const response = await fetch(`/api/process-url/${encodeURIComponent(recipeUrl)}`);
            
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || "Failed to process recipe URL");
            }
            
            const result = await response.json();
            currentViewMode = "flowchart";
            displayResult(result);
            
            // Clear the URL path from the address bar for a cleaner experience
            const newUrl = window.location.protocol + "//" + window.location.host + "/";
            window.history.replaceState({}, document.title, newUrl);
            
            console.log('‚úÖ Recipe URL processed successfully from path');
          } catch (error) {
            showError(`Error processing recipe URL: ${error.message}`);
          } finally {
            processBtn.disabled = false;
            processTableBtn.disabled = false;
            loading.style.display = "none";
          }
        }
      }

      // Initialize storage when page loads
      document.addEventListener('DOMContentLoaded', function() {
        initializeStorage();
        processUrlPath();
      });
    </script>
  </body>
</html>


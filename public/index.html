<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recipe Flowchart Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 300;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .content {
        padding: 40px;
      }

      .input-section {
        margin-bottom: 40px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      textarea {
        width: 100%;
        min-height: 200px;
        padding: 15px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        resize: vertical;
        transition: border-color 0.3s ease;
      }

      textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      input[type="url"]:focus {
        outline: none;
        border-color: #667eea;
      }

      .file-upload {
        position: relative;
        display: inline-block;
        cursor: pointer;
        background: #667eea;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        transition: background 0.3s ease;
      }

      .file-upload:hover {
        background: #5a6fd8;
      }

      .file-upload input[type="file"] {
        position: absolute;
        left: -9999px;
      }

      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        margin-right: 10px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .result-section {
        margin-top: 40px;
        padding-top: 40px;
        border-top: 2px solid #e1e5e9;
      }

      .result-section h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.8em;
      }

      .mermaid-container {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        overflow-x: auto;
      }

      .ingredients-list,
      .actions-list {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .ingredients-list h3,
      .actions-list h3 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.3em;
      }

      .ingredient-item,
      .action-item {
        background: white;
        padding: 10px 15px;
        margin-bottom: 8px;
        border-radius: 5px;
        border-left: 4px solid #667eea;
      }

      .action-item {
        border-left-color: #ff6b6b;
      }

      .error {
        background: #ffe6e6;
        color: #d63031;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #d63031;
        margin-top: 20px;
      }

      .example-recipe {
        background: #e8f4f8;
        border: 1px solid #bee5eb;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .example-recipe h4 {
        color: #0c5460;
        margin-bottom: 10px;
      }

      .example-recipe button {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
      }

      .example-recipe button:hover {
        background: #138496;
      }

      .example-recipe button.green {
        background: #28a745;
      }

      .example-recipe button.green:hover {
        background: #218838;
      }

      /* Table styling */
      #table-container table {
        border-collapse: collapse;
        width: 100%;
        margin: 0 auto;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      #table-container th,
      #table-container td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
        vertical-align: top;
      }

      #table-container th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #dee2e6;
      }

      #table-container .ingredient-cell {
        background-color: #e1f5fe;
        color: #01579b;
        font-weight: 500;
        border-left: 3px solid #01579b;
      }

      #table-container .step-cell {
        background-color: #fff3e0;
        color: #e65100;
        font-weight: 500;
        border-left: 3px solid #e65100;
      }

      #table-container .final-cell {
        background-color: #e8f5e8;
        color: #2e7d32;
        font-weight: 600;
        border-left: 3px solid #2e7d32;
        text-align: center;
      }

      #table-container .step-header {
        background-color: #f8f9fa;
        color: #495057;
        font-weight: 600;
        text-align: center;
        border-bottom: 2px solid #dee2e6;
      }

      #table-container tr:hover {
        background-color: #f5f5f5;
      }

      #table-container tr:hover .ingredient-cell,
      #table-container tr:hover .step-cell,
      #table-container tr:hover .final-cell {
        background-color: inherit;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üç≥ Recipe Flowchart Generator</h1>
        <p>Transform your recipes into beautiful Mermaid flowcharts using AI</p>
      </div>

      <div class="content">
        <div class="input-section">
          <div class="example-recipe">
            <h4>üìù Try with the example recipe:</h4>
            <p>
              Load the Mapo Tofu recipe and generate a flowchart, or load the
              pre-generated example directly.
            </p>
            <button onclick="loadExampleRecipe()">üìù Load Recipe Text</button>
            <button onclick="loadExampleFlowchart()" class="green">
              üöÄ Load Example Flowchart
            </button>
          </div>

          <div class="input-group">
            <label for="recipeText">üìã Paste your recipe here:</label>
            <textarea
              id="recipeText"
              placeholder="Paste your recipe text here... Include ingredients and instructions for best results."
            ></textarea>
          </div>

          <div class="input-group">
            <label for="recipeUrl">üåê Or enter a recipe URL:</label>
            <input
              type="url"
              id="recipeUrl"
              placeholder="https://example.com/recipe"
              style="
                width: 100%;
                padding: 15px;
                border: 2px solid #e1e5e9;
                border-radius: 8px;
                font-size: 16px;
                transition: border-color 0.3s ease;
              "
            />
            <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
              Supports most recipe websites including AllRecipes, Food Network, BBC Good Food, and more.
            </div>
          </div>

          <div class="input-group">
            <label>üìÅ Or upload a recipe file:</label>
            <div class="file-upload">
              <input
                type="file"
                id="recipeFile"
                accept=".txt,.md,.doc,.docx"
                onchange="handleFileUpload()"
              />
              Choose File
            </div>
            <span id="fileName" style="margin-left: 10px; color: #666"></span>
          </div>

          <button class="btn" onclick="processRecipe()" id="processBtn">
            üöÄ Generate Flowchart
          </button>
          <button
            class="btn"
            onclick="processRecipeTable()"
            id="processTableBtn"
            style="background: #17a2b8"
          >
            üìä Generate Table
          </button>
          <button class="btn" onclick="clearAll()" style="background: #6c757d">
            üóëÔ∏è Clear
          </button>
        </div>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Processing your recipe with AI...</p>
        </div>

        <div class="result-section" id="resultSection" style="display: none">
          <h2>üìä Recipe Flowchart</h2>

          <div class="flowchart-controls" style="margin-bottom: 20px">
            <button
              class="btn"
              onclick="downloadCurrent()"
              id="downloadBtn"
              style="background: #28a745"
            >
              üíæ Download
            </button>
            <button
              class="btn"
              onclick="toggleRawCode()"
              id="toggleCodeBtn"
              style="background: #17a2b8"
            >
              üîç Show/Hide Raw Code
            </button>
          </div>

          <div class="mermaid-container">
            <div id="mermaid-diagram"></div>
          </div>

          <div
            class="mermaid-code-container"
            id="mermaidCodeContainer"
            style="display: none"
          >
            <h3>üîß Raw Mermaid Code (for debugging)</h3>
            <pre
              id="mermaidCodeDisplay"
              style="
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                overflow-x: auto;
                font-family: 'Courier New', monospace;
                font-size: 12px;
                border: 1px solid #dee2e6;
              "
            ></pre>
          </div>

          <div class="ingredients-list" id="ingredientsList"></div>
          <div class="actions-list" id="actionsList"></div>
        </div>

        <div id="errorMessage" class="error" style="display: none"></div>
      </div>
    </div>

    <script>
      // Initialize Mermaid
      mermaid.initialize({
        startOnLoad: false,
        theme: "default",
        flowchart: {
          useMaxWidth: true,
          htmlLabels: true,
        },
      });

      let uploadedFile = null;
      let currentMermaidCode = null;
      let currentHtmlTable = null;
      let currentRecipeName = null;
      let currentViewMode = "flowchart"; // 'flowchart' or 'table'
      let currentRecipeData = null; // Store complete recipe data for saving

      function loadExampleRecipe() {
        const exampleRecipe = `MAPO TOFU

INGREDIENTS
‚ñ¢ 1/2 cup oil (divided)
‚ñ¢ 1-2 fresh Thai bird chili peppers (thinly sliced)
‚ñ¢ 6-8 dried red chilies (roughly chopped)
‚ñ¢ 1/2- 1 1/2 tablespoons Sichuan peppercorns (powdered or finely ground, reserving 1/4 teaspoon for garnish at the end; if you want a milder flavor use 1/2 or 1 teaspoon ground Sichuan peppercorn)
‚ñ¢ 3 tablespoons ginger (finely minced)
‚ñ¢ 3 tablespoons garlic (finely minced)
‚ñ¢ 8 ounces ground pork
‚ñ¢ 1-2 tablespoons spicy bean sauce (depending on your desired salt/spice levels)
‚ñ¢ 2/3 cup low sodium chicken broth (or water)
‚ñ¢ 1 pound silken tofu (cut into 1 inch/2.5cm cubes)
‚ñ¢ 1/4 cup water
‚ñ¢ 1 1/2 teaspoons cornstarch
‚ñ¢ 1/4 teaspoon sesame oil (optional)
‚ñ¢ 1/4 teaspoon sugar (optional)
‚ñ¢ 1 scallion (finely chopped)

INSTRUCTIONS

First, we toast the chilies. If you have homemade toasted chili oil, you can skip this step. Heat your wok or a small saucepan over low heat. Add half of the oil and throw in the fresh and dried peppers. Stir occasionally and heat until fragrant, about 5 minutes, ensuring that the peppers don't burn. Remove from heat and set aside.
Heat the remaining half of the oil in your wok over medium heat. Add the ginger. After 1 minute, add the garlic. Fry for another minute, and then turn up the heat to high and add the ground pork. Break up the meat and fry it until it's cooked through. Add your ground Sichuan peppercorns and stir for about 15-30 seconds, taking care to not let it burn, as it will turn bitter if it does.
Add the spicy bean sauce to the mixture and stir it in well. Add the chicken broth to the wok and stir. Let this simmer for a minute or so. While that's happening, ready your tofu and combine the water and cornstarch in a small bowl.
Add the cornstarch mixture to your sauce and stir. Let it bubble away until the sauce starts to thicken. (If it gets too thick, splash in a little more water or chicken stock.)
Then add your chili oil from before‚Äîpeppers and all! If you are using homemade chili oil, ONLY use the standing oil, as it's likely that you have salted it and you only want the oil, not additional salt. Stir the oil into the sauce, and add the tofu. Use your spatula to gently toss the tofu in the sauce. Let everything cook for 3-5 minutes. Add the sesame oil and sugar (if using) along with the scallions and stir until the scallions are just wilted.
Serve with a last sprinkle of Sichuan peppercorn powder as a garnish if desired.`;

        document.getElementById("recipeText").value = exampleRecipe;
      }

      async function loadExampleFlowchart() {
        const processBtn = document.getElementById("processBtn");
        const loading = document.getElementById("loading");
        const resultSection = document.getElementById("resultSection");
        const errorMessage = document.getElementById("errorMessage");

        // Show loading state
        processBtn.disabled = true;
        loading.style.display = "block";
        resultSection.style.display = "none";
        errorMessage.style.display = "none";

        try {
          const response = await fetch("/api/example-flowchart");

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error || "Failed to load example flowchart"
            );
          }

          const result = await response.json();
          displayResult(result);
        } catch (error) {
          showError(`Error: ${error.message}`);
        } finally {
          processBtn.disabled = false;
          loading.style.display = "none";
        }
      }

      function handleFileUpload() {
        const fileInput = document.getElementById("recipeFile");
        const fileName = document.getElementById("fileName");

        if (fileInput.files.length > 0) {
          uploadedFile = fileInput.files[0];
          fileName.textContent = `Selected: ${uploadedFile.name}`;
        } else {
          uploadedFile = null;
          fileName.textContent = "";
        }
      }

      async function processRecipe() {
        const recipeText = document.getElementById("recipeText").value.trim();
        const recipeUrl = document.getElementById("recipeUrl").value.trim();
        const processBtn = document.getElementById("processBtn");
        const processTableBtn = document.getElementById("processTableBtn");
        const loading = document.getElementById("loading");
        const resultSection = document.getElementById("resultSection");
        const errorMessage = document.getElementById("errorMessage");

        if (!recipeText && !uploadedFile && !recipeUrl) {
          showError("Please enter a recipe, upload a file, or provide a recipe URL.");
          return;
        }

        // If URL is provided, process it instead
        if (recipeUrl) {
          await processRecipeFromURL(recipeUrl);
          return;
        }

        // Show loading state
        processBtn.disabled = true;
        processTableBtn.disabled = true;
        loading.style.display = "block";
        resultSection.style.display = "none";
        errorMessage.style.display = "none";

        try {
          let response;

          if (uploadedFile) {
            // Upload file
            const formData = new FormData();
            formData.append("recipeFile", uploadedFile);

            response = await fetch("/api/upload-recipe", {
              method: "POST",
              body: formData,
            });
          } else {
            // Process text
            response = await fetch("/api/process-recipe", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ recipeText }),
            });
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to process recipe");
          }

          const result = await response.json();
          currentViewMode = "flowchart";
          displayResult(result);
        } catch (error) {
          showError(`Error: ${error.message}`);
        } finally {
          processBtn.disabled = false;
          processTableBtn.disabled = false;
          loading.style.display = "none";
        }
      }

      async function processRecipeFromURL(recipeUrl) {
        const processBtn = document.getElementById("processBtn");
        const processTableBtn = document.getElementById("processTableBtn");
        const loading = document.getElementById("loading");
        const resultSection = document.getElementById("resultSection");
        const errorMessage = document.getElementById("errorMessage");

        // Show loading state
        processBtn.disabled = true;
        processTableBtn.disabled = true;
        loading.style.display = "block";
        resultSection.style.display = "none";
        errorMessage.style.display = "none";

        try {
          const response = await fetch("/api/process-recipe-url", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ recipeUrl }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to process recipe URL");
          }

          const result = await response.json();
          currentViewMode = "flowchart";
          displayResult(result);
        } catch (error) {
          showError(`Error: ${error.message}`);
        } finally {
          processBtn.disabled = false;
          processTableBtn.disabled = false;
          loading.style.display = "none";
        }
      }

      async function processRecipeTable() {
        const recipeText = document.getElementById("recipeText").value.trim();
        const recipeUrl = document.getElementById("recipeUrl").value.trim();
        const processBtn = document.getElementById("processBtn");
        const processTableBtn = document.getElementById("processTableBtn");
        const loading = document.getElementById("loading");
        const resultSection = document.getElementById("resultSection");
        const errorMessage = document.getElementById("errorMessage");

        if (!recipeText && !uploadedFile && !recipeUrl) {
          showError("Please enter a recipe, upload a file, or provide a recipe URL.");
          return;
        }

        // If URL is provided, we need to scrape it first
        if (recipeUrl) {
          // For now, show error for URL + table combination
          showError("Table view is not yet supported for recipe URLs. Please use the flowchart view.");
          return;
        }

        // Show loading state
        processBtn.disabled = true;
        processTableBtn.disabled = true;
        loading.style.display = "block";
        resultSection.style.display = "none";
        errorMessage.style.display = "none";

        try {
          let response;

          if (uploadedFile) {
            // For file uploads, we'll need to read the file content
            const fileContent = await readFileContent(uploadedFile);
            response = await fetch("/api/process-recipe-table", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ recipeText: fileContent }),
            });
          } else {
            // Process text
            response = await fetch("/api/process-recipe-table", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ recipeText }),
            });
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error || "Failed to process recipe to table"
            );
          }

          const result = await response.json();
          currentViewMode = "table";
          displayTableResult(result);
        } catch (error) {
          showError(`Error: ${error.message}`);
        } finally {
          processBtn.disabled = false;
          processTableBtn.disabled = false;
          loading.style.display = "none";
        }
      }

      function readFileContent(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = (e) => reject(e);
          reader.readAsText(file);
        });
      }

      function displayResult(result) {
        const resultSection = document.getElementById("resultSection");
        const mermaidContainer = document.getElementById("mermaid-diagram");
        const ingredientsList = document.getElementById("ingredientsList");
        const actionsList = document.getElementById("actionsList");

        // Store the Mermaid code and recipe name for download
        currentMermaidCode = result.mermaidDiagram;
        currentRecipeName = result.recipeName || result.scrapedTitle || "recipe";

        // Clear the container and render new Mermaid diagram
        mermaidContainer.innerHTML = "";

        // Create a unique ID for this diagram
        const diagramId = "mermaid-diagram-" + Date.now();
        mermaidContainer.innerHTML = `<div id="${diagramId}">${result.mermaidDiagram}</div>`;

        // Initialize Mermaid with the new content
        mermaid.init(undefined, document.getElementById(diagramId));

        // Display ingredients if available
        if (result.ingredients && result.ingredients.length > 0) {
          ingredientsList.innerHTML = `
            <h3>ü•ò Ingredients (${result.ingredients.length})</h3>
            ${result.ingredients
              .map(
                (ingredient) => `
              <div class="ingredient-item">
                <strong>${ingredient.name}</strong> <span style="color: #667eea; font-weight: 600;">${ingredient.quantity || 'No quantity specified'}</span>
                <div style="color: #666; font-size: 0.9em; margin-top: 4px;">${ingredient.description}</div>
              </div>
            `
              )
              .join("")}
          `;
        } else {
          ingredientsList.innerHTML = "";
        }

        // Display actions if available
        if (result.actions && result.actions.length > 0) {
          actionsList.innerHTML = `
            <h3>üë®‚Äçüç≥ Cooking Actions (${result.actions.length})</h3>
            ${result.actions
              .map(
                (action) => `
              <div class="action-item">
                <strong>${
                  action.name
                }</strong> <span style="color: #ff6b6b; font-size: 0.9em;">(${
                  action.duration
                } min)</span>
                <div style="color: #666; font-size: 0.9em; margin-top: 4px;">${
                  action.description
                }</div>
                <div style="color: #888; font-size: 0.8em; margin-top: 4px;">
                  Inputs: ${action.inputIngredients.join(
                    ", "
                  )} ‚Üí Outputs: ${action.outputIngredients.join(", ")}
                </div>
              </div>
            `
              )
              .join("")}
          `;
        } else {
          actionsList.innerHTML = "";
        }

        // Show source information if available
        if (result.originalUrl) {
          const sourceInfo = document.createElement("div");
          sourceInfo.style.cssText = `
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9em;
          `;
          sourceInfo.innerHTML = `
            <strong>üìÑ Source:</strong> <a href="${result.originalUrl}" target="_blank" style="color: #17a2b8;">${result.originalUrl}</a>
            ${result.scrapedTitle ? `<br><strong>üìù Title:</strong> ${result.scrapedTitle}` : ''}
          `;
          resultSection.insertBefore(sourceInfo, resultSection.firstChild);
        }

        resultSection.style.display = "block";
      }

      function displayTableResult(result) {
        const resultSection = document.getElementById("resultSection");
        const mermaidContainer = document.getElementById("mermaid-diagram");
        const ingredientsList = document.getElementById("ingredientsList");
        const actionsList = document.getElementById("actionsList");

        // Store the HTML table and recipe name for download
        currentHtmlTable = result.htmlTable;
        currentRecipeName = result.recipeName || "recipe";

        // Hide Mermaid container and show HTML table
        mermaidContainer.style.display = "none";

        // Create or update table container
        let tableContainer = document.getElementById("table-container");
        if (!tableContainer) {
          tableContainer = document.createElement("div");
          tableContainer.id = "table-container";
          tableContainer.style.cssText = `
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-x: auto;
          `;
          mermaidContainer.parentNode.insertBefore(
            tableContainer,
            mermaidContainer
          );
        }

        tableContainer.innerHTML = result.htmlTable;
        tableContainer.style.display = "block";

        // Display ingredients if available
        if (result.ingredients && result.ingredients.length > 0) {
          ingredientsList.innerHTML = `
            <h3>ü•ò Ingredients (${result.ingredients.length})</h3>
            ${result.ingredients
              .map(
                (ingredient) => `
              <div class="ingredient-item">
                <strong>${ingredient.name}</strong> <span style="color: #667eea; font-weight: 600;">${ingredient.quantity || 'No quantity specified'}</span>
                <div style="color: #666; font-size: 0.9em; margin-top: 4px;">${ingredient.description}</div>
              </div>
            `
              )
              .join("")}
          `;
        } else {
          ingredientsList.innerHTML = "";
        }

        // Display steps if available
        if (result.steps && result.steps.length > 0) {
          actionsList.innerHTML = `
            <h3>üë®‚Äçüç≥ Cooking Steps (${result.steps.length})</h3>
            ${result.steps
              .map(
                (step) => `
              <div class="action-item">
                <strong>${
                  step.name
                }</strong> <span style="color: #ff6b6b; font-size: 0.9em;">(${
                  step.duration
                } min)</span>
                <div style="color: #666; font-size: 0.9em; margin-top: 4px;">${
                  step.description
                }</div>
                <div style="color: #888; font-size: 0.8em; margin-top: 4px;">
                  Involves: ${step.involvedIngredients.join(", ")}
                </div>
              </div>
            `
              )
              .join("")}
          `;
        } else {
          actionsList.innerHTML = "";
        }

        resultSection.style.display = "block";
      }

      function showError(message) {
        const errorMessage = document.getElementById("errorMessage");
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
      }

      function downloadMermaidCode() {
        if (!currentMermaidCode) {
          showError("No Mermaid code available to download.");
          return;
        }

        try {
          const response = fetch("/api/download-mermaid", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              mermaidCode: currentMermaidCode,
              recipeName: currentRecipeName,
            }),
          });

          response
            .then((res) => {
              if (res.ok) {
                return res.blob();
              } else {
                throw new Error("Failed to download Mermaid code");
              }
            })
            .then((blob) => {
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.style.display = "none";
              a.href = url;
              a.download = `${currentRecipeName}_flowchart.mmd`;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
            })
            .catch((error) => {
              showError(`Error downloading file: ${error.message}`);
            });
        } catch (error) {
          showError(`Error downloading file: ${error.message}`);
        }
      }

      function downloadHtmlTable() {
        if (!currentHtmlTable) {
          showError("No HTML table available to download.");
          return;
        }

        try {
          const response = fetch("/api/download-table", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              htmlTable: currentHtmlTable,
              recipeName: currentRecipeName,
            }),
          });

          response
            .then((res) => {
              if (res.ok) {
                return res.blob();
              } else {
                throw new Error("Failed to download HTML table");
              }
            })
            .then((blob) => {
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.style.display = "none";
              a.href = url;
              a.download = `${currentRecipeName}_table.html`;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
            })
            .catch((error) => {
              showError(`Error downloading file: ${error.message}`);
            });
        } catch (error) {
          showError(`Error downloading file: ${error.message}`);
        }
      }

      function downloadCurrent() {
        if (currentViewMode === "flowchart") {
          downloadMermaidCode();
        } else if (currentViewMode === "table") {
          downloadHtmlTable();
        } else {
          showError("No content available to download.");
        }
      }

      function toggleRawCode() {
        const codeContainer = document.getElementById("mermaidCodeContainer");
        const codeDisplay = document.getElementById("mermaidCodeDisplay");
        const toggleBtn = document.getElementById("toggleCodeBtn");

        if (codeContainer.style.display === "none") {
          if (currentViewMode === "flowchart" && currentMermaidCode) {
            codeDisplay.textContent = currentMermaidCode;
            codeContainer.style.display = "block";
            toggleBtn.textContent = "üîç Hide Raw Code";
          } else if (currentViewMode === "table" && currentHtmlTable) {
            codeDisplay.innerHTML = currentHtmlTable;
            codeContainer.style.display = "block";
            toggleBtn.textContent = "üîç Hide Raw Code";
          } else {
            showError("No raw code available to display.");
          }
        } else {
          codeContainer.style.display = "none";
          toggleBtn.textContent = "üîç Show Raw Code";
        }
      }

      function clearAll() {
        document.getElementById("recipeText").value = "";
        document.getElementById("recipeUrl").value = "";
        document.getElementById("recipeFile").value = "";
        document.getElementById("fileName").textContent = "";
        document.getElementById("resultSection").style.display = "none";
        document.getElementById("errorMessage").style.display = "none";
        document.getElementById("mermaidCodeContainer").style.display = "none";
        document.getElementById("toggleCodeBtn").textContent =
          "üîç Show Raw Code";

        // Hide table container if it exists
        const tableContainer = document.getElementById("table-container");
        if (tableContainer) {
          tableContainer.style.display = "none";
        }

        // Show Mermaid container
        document.getElementById("mermaid-diagram").style.display = "block";

        uploadedFile = null;
        currentMermaidCode = null;
        currentHtmlTable = null;
        currentRecipeName = null;
        currentViewMode = "flowchart";
      }
    </script>
  </body>
</html>

